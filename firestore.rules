rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS (MUST BE DEFINED FIRST)
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Get current user's document from users collection
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Check if user document exists and is active
    function userExistsAndActive() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             getUserData().isActive == true;
    }
    
    // Check if user is a manager
    function isManager() {
      return userExistsAndActive() && getUserData().role == 'manager';
    }
    
    // Check if user is HR
    function isHR() {
      return userExistsAndActive() && getUserData().role == 'hr';
    }
    
    // Check if user is staff
    function isStaff() {
      return userExistsAndActive() && getUserData().role == 'staff';
    }
    
    // Check if user is an admin (has admin role OR has any admin permissions)
    // This allows dynamic roles to work without updating rules
    function isAdmin() {
      return userExistsAndActive() && (
        // System roles (backward compatibility)
        getUserData().role in ['manager', 'hr', 'staff', 'admin'] ||
        // OR has any admin permissions (for dynamic roles)
        (getUserData().permissions is list && 
         getUserData().permissions.hasAny(['all', 'post_moderation', 'user_management', 'analytics', 'monitoring', 'system_config', 'message_oversight', 'role_management']))
      );
    }
    
    // Check if user has a specific permission
    // Note: Firestore rules use hasAny() to check if array contains value
    // This works for both system roles and dynamically created roles
    function hasPermission(permission) {
      return userExistsAndActive() && 
             getUserData().permissions is list &&
             (getUserData().permissions.hasAny([permission, 'all']));
    }
    
    // Check if user has role management permission
    function hasRoleManagementPermission() {
      return hasPermission('role_management');
    }
    
    // ============================================
    // ROLES COLLECTION
    // ============================================
    match /roles/{roleId} {
      // Read: Allow any authenticated user to read roles
      // This is needed for login validation, creating users, assigning roles, and viewing role information
      allow read: if isAuthenticated();
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Allow users to read their own document (needed for login)
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // Allow users to create their own document (needed during registration/admin creation)
      // This is needed because createUserWithEmailAndPassword signs in the new user
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Permission-based: users with user_management permission can read/write
      // Backward compatibility: system roles (manager, HR, staff) also have access
      allow read, write: if hasPermission('user_management') || isManager() || isHR() || isStaff();
    }
    
    // Allow listing all users (for queries)
    match /users/{document=**} {
      allow read: if hasPermission('user_management') || isManager() || isHR() || isStaff();
    }
    
    // ============================================
    // POSTS COLLECTION
    // ============================================
    match /posts/{postId} {
      // Permission-based: users with post_moderation permission can read/write
      allow read, write: if hasPermission('post_moderation') || isManager() || isHR() || isStaff();
    }
    
    // ============================================
    // JOB POSTS COLLECTION (for analytics)
    // ============================================
    match /job_posts/{postId} {
      // Permission-based: users with post_moderation or analytics permission can read/write
      allow read, write: if hasPermission('post_moderation') || hasPermission('analytics') || isManager() || isHR() || isStaff();
    }
    
    // ============================================
    // CATEGORIES COLLECTION
    // ============================================
    match /categories/{categoryId} {
      // All authenticated users can read categories
      allow read: if isSignedIn();
      
      // Permission-based: users with post_moderation permission can create categories
      allow create: if hasPermission('post_moderation') || isManager() || isHR() || isStaff();
      
      allow update: if isSignedIn() && (
        // Allow users with post_moderation permission to update any field
        hasPermission('post_moderation') || isManager() || isHR() || isStaff() ||
        // Allow any authenticated user to update only jobCount and updatedAt
        // Verify all other fields remain unchanged
        (request.resource.data.name == resource.data.name &&
         request.resource.data.description == resource.data.description &&
         request.resource.data.isActive == resource.data.isActive &&
         request.resource.data.jobCount is int &&
         request.resource.data.updatedAt is timestamp)
      );
      
      // Permission-based: users with post_moderation permission can delete
      allow delete: if hasPermission('post_moderation') || isManager() || isHR() || isStaff();
    }
    
    // ============================================
    // ANALYTICS / REPORTING
    // ============================================
    match /analytics/{docId} {
      // Permission-based: users with analytics permission can read/write
      allow read, write: if hasPermission('analytics') || isManager() || isHR();
    }
    
    // ============================================
    // MESSAGES COLLECTION
    // ============================================
    match /messages/{msgId} {
      // Permission-based: users with message_oversight permission can read/write
      allow read, write: if hasPermission('message_oversight') || isManager() || isHR() || isStaff();
    }
    
    // ============================================
    // APPLICATIONS COLLECTION (for job applications)
    // ============================================
    match /applications/{applicationId} {
      // Permission-based: users with post_moderation permission can read/write
      allow read, write: if hasPermission('post_moderation') || isManager() || isHR() || isStaff();
    }
    
    // ============================================
    // REPORTS COLLECTION (for user/content reports)
    // ============================================
    match /reports/{reportId} {
      // Permission-based: users with user_management or post_moderation permission can read/write
      allow read, write: if hasPermission('user_management') || hasPermission('post_moderation') || isManager() || isHR() || isStaff();
    }
    
    // ============================================
    // PENDING PAYMENTS COLLECTION (for credit/revenue analytics)
    // ============================================
    match /pending_payments/{paymentId} {
      // Permission-based: users with analytics permission can read/write
      allow read, write: if hasPermission('analytics') || isManager() || isHR();
    }
    
    // ============================================
    // WALLETS COLLECTION
    // ============================================
    match /wallets/{walletId} {
      // Allow users to read their own wallet
      allow read: if isAuthenticated() && request.auth.uid == walletId;
      // Permission-based: users with user_management permission can read/write
      // Also allow managers and HR to access wallets
      allow read, write: if hasPermission('user_management') || isManager() || isHR();
    }
    
    // ============================================
    // LOGS COLLECTION (for tracking warnings, deductions, etc.)
    // ============================================
    match /logs/{logId} {
      // Permission-based: users with user_management, post_moderation, analytics, monitoring permissions, managers, or HR can read/write
      allow read, write: if hasPermission('user_management') || hasPermission('post_moderation') || hasPermission('analytics') || hasPermission('monitoring') || isManager() || isHR();
    }
    
    // Allow listing all logs (for queries)
    match /logs/{document=**} {
      allow read: if hasPermission('user_management') || hasPermission('post_moderation') || hasPermission('analytics') || hasPermission('monitoring') || isManager() || isHR();
    }
    
    // ============================================
    // REVIEWS COLLECTION (for ratings/reviews)
    // ============================================
    match /reviews/{reviewId} {
      // Read: 
      // 1. Users can read their own reviews (as employer or employee)
      // 2. Admins with message_oversight permission can read all reviews
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.employerId ||
        request.auth.uid == resource.data.employeeId ||
        hasPermission('message_oversight') || isManager() || isHR() || isStaff()
      );
      
      // Create:
      // 1. Authenticated users can create reviews (employers rating employees)
      // 2. Must be the employer creating the review
      allow create: if isAuthenticated() && 
                     request.auth.uid == request.resource.data.employerId &&
                     request.resource.data.keys().hasAll(['employerId', 'employeeId', 'postId', 'rating', 'createdAt']) &&
                     request.resource.data.employerId is string &&
                     request.resource.data.employeeId is string &&
                     request.resource.data.postId is string &&
                     request.resource.data.rating is number &&
                     request.resource.data.rating >= 1 &&
                     request.resource.data.rating <= 5 &&
                     request.resource.data.createdAt is timestamp;
      
      // Update:
      // 1. Only admins with message_oversight permission can update reviews (for moderation)
      // 2. Users cannot update their own reviews after creation
      allow update: if hasPermission('message_oversight') || isManager() || isHR() || isStaff();
      
      // Delete:
      // 1. Only admins with message_oversight permission can delete reviews
      allow delete: if hasPermission('message_oversight') || isManager() || isHR() || isStaff();
    }
    
    // Allow listing all reviews (for queries)
    match /reviews/{document=**} {
      allow read: if hasPermission('message_oversight') || isManager() || isHR() || isStaff();
    }
    
    // ============================================
    // NOTIFICATIONS COLLECTION
    // ============================================
    match /notifications/{notificationId} {
      // Permission-based: users with user_management permission can read/write
      allow write: if hasPermission('user_management') || isManager() || isHR() || isStaff();
      // All authenticated users can read their own notifications
      allow read: if isAuthenticated();
    }
    
    // ============================================
    // TAG CATEGORIES COLLECTION
    // ============================================
    match /tagCategories/{tagCategoryId} {
      // All authenticated users can read tag categories
      allow read: if isSignedIn();
      // Permission-based: users with post_moderation permission can write
      allow write: if hasPermission('post_moderation') || isManager() || isHR() || isStaff();
    }
    
    // ============================================
    // TAGS COLLECTION
    // ============================================
    match /tags/{tagId} {
      // All authenticated users can read tags
      allow read: if isSignedIn();
      // Permission-based: users with post_moderation permission can write
      allow write: if hasPermission('post_moderation') || isManager() || isHR() || isStaff();
    }
    
    // ============================================
    // ADMINS COLLECTION (if still used)
    // ============================================
    match /admins/{adminId} {
      // Allow admins to read their own data
      allow read: if isAuthenticated() && request.auth.uid == adminId;
      // Only allow writes by authenticated users (you may want to restrict this further)
      allow write: if isAuthenticated();
    }
    
    // ============================================
    // DEFAULT: Deny all other access
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
