rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS (MUST BE DEFINED FIRST)
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is signed in (alias for isAuthenticated)
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Get current user's document from users collection
    // Only call this after checking exists() first
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Check if user document exists and is active
    function userExistsAndActive() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             getUserData().isActive == true;
    }
    
    // Check if user is a manager
    function isManager() {
      return userExistsAndActive() && getUserData().role == 'manager';
    }
    
    // Check if user is HR
    function isHR() {
      return userExistsAndActive() && getUserData().role == 'hr';
    }
    
    // Check if user is staff
    function isStaff() {
      return userExistsAndActive() && getUserData().role == 'staff';
    }
    
    // Check if user is an admin (has admin role OR has any admin permissions)
    function isAdmin() {
      return userExistsAndActive() && (
        getUserData().role in ['manager', 'hr', 'staff'] ||
        (getUserData().permissions is list && 
         getUserData().permissions.hasAny(['all', 'post_moderation', 'user_management', 'analytics', 'monitoring', 'system_config', 'message_oversight', 'role_management']))
      );
    }
    
    // Check if user has a specific permission
    function hasPermission(permission) {
      return userExistsAndActive() && 
             getUserData().permissions is list &&
             (getUserData().permissions.hasAny([permission, 'all']));
    }
    
    // Check if user has role management permission
    function hasRoleManagementPermission() {
      return hasPermission('role_management');
    }
    
    // Check if user is self
    function isSelf(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // ============================================
    // ROLES COLLECTION
    // ============================================
    match /roles/{roleId} {
      allow read, list: if isAuthenticated();
      allow create, update, delete: if false;
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    
    // CRITICAL: Allow list queries on users collection for admins
    // This must come BEFORE the /users/{userId} rule
    match /users/{document=**} {
      // Allow admins to query (list) users collection
      allow list: if hasPermission('user_management') || 
                   isManager() || 
                   isHR() || 
                   isStaff();
      
      // Allow admins to get any user document
      allow get: if hasPermission('user_management') || 
                  isManager() || 
                  isHR() || 
                  isStaff();
    }
    
    // Individual user document rules
    match /users/{userId} {
      // Allow users to read their own document (needed for login)
      allow get: if isAuthenticated() && request.auth.uid == userId;
      
      // Allow admins to read any user document
      allow get: if hasPermission('user_management') || 
                  isManager() || 
                  isHR() || 
                  isStaff();
      
      // Allow create/update:
      // 1. Users can create/update their own document (for registration)
      // 2. Admins can create/update any user
      allow create, update: if isSelf(userId) || 
                            hasPermission('user_management') || 
                            isManager() || 
                            isHR() || 
                            isStaff();
      
      allow delete: if false;
    }
    
    // ============================================
    // REPORTS COLLECTION
    // ============================================
    
    // CRITICAL: Allow list queries on reports collection for admins
    match /reports/{document=**} {
      // Allow admins to query (list) reports collection
      allow list: if hasPermission('user_management') || 
                   hasPermission('post_moderation') || 
                   isManager() || 
                   isHR() || 
                   isStaff();
      
      // Allow admins to get any report document
      allow get: if hasPermission('user_management') || 
                  hasPermission('post_moderation') || 
                  isManager() || 
                  isHR() || 
                  isStaff();
    }
    
    match /reports/{reportId} {
      // Allow users to read their own reports
      allow get: if isSignedIn() && resource.data.reporterId == request.auth.uid;
      
      // Allow admins to read any report
      allow get: if hasPermission('user_management') || 
                  hasPermission('post_moderation') || 
                  isManager() || 
                  isHR() || 
                  isStaff();
      
      // Allow admins to query reports
      allow list: if hasPermission('user_management') || 
                   hasPermission('post_moderation') || 
                   isManager() || 
                   isHR() || 
                   isStaff();
      
      // Authenticated users can create reports
      allow create: if isSignedIn() &&
        request.resource.data.reporterId == request.auth.uid &&
        request.resource.data.type in ['post', 'jobseeker'] &&
        request.resource.data.reason is string &&
        request.resource.data.description is string &&
        request.resource.data.status == 'pending';
      
      // Only admins can update/delete reports
      allow update, delete: if hasPermission('user_management') || 
                             hasPermission('post_moderation') || 
                             isManager() || 
                             isHR() || 
                             isStaff();
    }
    
    // ============================================
    // POSTS COLLECTION
    // ============================================
    match /posts/{postId} {
      allow read, list, write: if hasPermission('post_moderation') || 
                                 isManager() || 
                                 isHR() || 
                                 isStaff();
    }
    
    // ============================================
    // JOB POSTS COLLECTION (for analytics)
    // ============================================
    match /job_posts/{postId} {
      allow read, list, write: if hasPermission('post_moderation') || 
                                 hasPermission('analytics') || 
                                 isManager() || 
                                 isHR() || 
                                 isStaff();
    }
    
    // ============================================
    // CATEGORIES COLLECTION
    // ============================================
    match /categories/{categoryId} {
      allow read, list: if isSignedIn();
      
      allow create: if hasPermission('post_moderation') || 
                     isManager() || 
                     isHR() || 
                     isStaff();
      
      allow update: if isSignedIn() && (
        hasPermission('post_moderation') || 
        isManager() || 
        isHR() || 
        isStaff() ||
        (request.resource.data.name == resource.data.name &&
         request.resource.data.description == resource.data.description &&
         request.resource.data.isActive == resource.data.isActive &&
         request.resource.data.jobCount is int &&
         request.resource.data.updatedAt is timestamp)
      );
      
      allow delete: if hasPermission('post_moderation') || 
                     isManager() || 
                     isHR() || 
                     isStaff();
    }
    
    // ============================================
    // ANALYTICS / REPORTING
    // ============================================
    match /analytics/{docId} {
      allow read, list, write: if hasPermission('analytics') || 
                                 isManager() || 
                                 isHR();
    }
    
    // ============================================
    // WALLET COLLECTION
    // ============================================
    match /wallets/{walletId} {
      allow read, list, write: if hasPermission('user_management') || 
                                 isManager() || 
                                 isHR();
    }
    
    // ============================================
    // LOGS COLLECTION
    // ============================================
    
    // Allow list queries on logs collection
    match /logs/{document=**} {
      allow list: if hasPermission('user_management') || 
                   isManager() || 
                   isHR();
      
      allow get: if hasPermission('user_management') || 
                  isManager() || 
                  isHR();
    }
    
    match /logs/{logId} {
      allow read, write: if hasPermission('user_management') || 
                          isManager() || 
                          isHR();
    }
    
    // ============================================
    // APPLICATIONS COLLECTION
    // ============================================
    match /applications/{applicationId} {
      allow read, list, write: if hasPermission('post_moderation') || 
                                 isManager() || 
                                 isHR() || 
                                 isStaff();
    }
    
    // ============================================
    // PENDING PAYMENTS COLLECTION
    // ============================================
    match /pending_payments/{paymentId} {
      allow read, list, write: if hasPermission('analytics') || 
                                 isManager() || 
                                 isHR();
    }
    
    // ============================================
    // NOTIFICATIONS COLLECTION
    // ============================================
    match /notifications/{notificationId} {
      allow write: if hasPermission('user_management') || 
                    isManager() || 
                    isHR() || 
                    isStaff();
      
      allow read, list: if isAuthenticated();
    }
    
    // ============================================
    // TAG CATEGORIES COLLECTION
    // ============================================
    match /tagCategories/{tagCategoryId} {
      allow read, list: if isSignedIn();
      allow write: if hasPermission('post_moderation') || 
                    isManager() || 
                    isHR() || 
                    isStaff();
    }
    
    // ============================================
    // TAGS COLLECTION
    // ============================================
    match /tags/{tagId} {
      allow read, list: if isSignedIn();
      allow write: if hasPermission('post_moderation') || 
                    isManager() || 
                    isHR() || 
                    isStaff();
    }
    
    // ============================================
    // MATCHING RULES COLLECTION
    // ============================================
    match /matching_rules/{ruleId} {
      allow read, list: if isAuthenticated();
      allow write: if hasPermission('system_config') || 
                    isManager() || 
                    isHR() || 
                    isStaff();
    }
    
    // ============================================
    // SYSTEM CONFIG COLLECTION
    // ============================================
    match /system_config/{configId} {
      allow read, list: if isAuthenticated();
      allow write: if hasPermission('system_config') || 
                    isManager() || 
                    isHR() || 
                    isStaff();
    }
    
    // ============================================
    // JOB MATCHES COLLECTION
    // ============================================
    match /job_matches/{matchId} {
      allow get: if isAuthenticated() && (
        resource.data.jobseekerId == request.auth.uid ||
        resource.data.recruiterId == request.auth.uid
      );
      
      allow list: if isAuthenticated();
      
      allow create: if isAuthenticated() &&
        request.resource.data.jobId is string &&
        request.resource.data.jobTitle is string &&
        request.resource.data.companyName is string &&
        request.resource.data.recruiterId is string &&
        request.resource.data.jobseekerId is string &&
        request.resource.data.status is string &&
        request.resource.data.status in ['pending', 'applied'] &&
        (request.resource.data.matchingStrategy == null ||
         request.resource.data.matchingStrategy is string &&
         request.resource.data.matchingStrategy in ['embedding_ann', 'stable_optimal']);
      
      allow update: if isAuthenticated() && (
        (resource.data.jobseekerId == request.auth.uid &&
         request.resource.data.status == 'applied' &&
         resource.data.status == 'pending' &&
         request.resource.data.jobId == resource.data.jobId &&
         request.resource.data.jobseekerId == resource.data.jobseekerId &&
         request.resource.data.recruiterId == resource.data.recruiterId) ||
        (request.resource.data.jobId is string &&
         request.resource.data.jobTitle is string &&
         request.resource.data.companyName is string &&
         request.resource.data.recruiterId is string &&
         request.resource.data.jobseekerId is string &&
         request.resource.data.status is string &&
         request.resource.data.status in ['pending', 'applied'] &&
         (request.resource.data.matchingStrategy == null ||
          request.resource.data.matchingStrategy is string &&
          request.resource.data.matchingStrategy in ['embedding_ann', 'stable_optimal']) &&
         request.resource.data.jobId == resource.data.jobId &&
         request.resource.data.jobseekerId == resource.data.jobseekerId &&
         request.resource.data.recruiterId == resource.data.recruiterId)
      );
      
      allow delete: if false;
    }
    
    // ============================================
    // MESSAGES COLLECTION
    // ============================================
    match /messages/{msgId} {
      allow read, list, write: if hasPermission('message_oversight') || 
                                 isManager() || 
                                 isHR() || 
                                 isStaff();
    }
    
    // ============================================
    // CONVERSATIONS COLLECTION
    // ============================================
    match /conversations/{conversationId} {
      allow read, list: if hasPermission('message_oversight') || 
                         hasPermission('analytics') || 
                         isManager() || 
                         isHR() || 
                         isStaff();
      
      allow write: if hasPermission('message_oversight') || 
                    isManager() || 
                    isHR() || 
                    isStaff();
      
      match /messages/{messageId} {
        allow read, list: if hasPermission('message_oversight') || 
                           hasPermission('analytics') || 
                           isManager() || 
                           isHR() || 
                           isStaff();
        
        allow write: if hasPermission('message_oversight') || 
                      isManager() || 
                      isHR() || 
                      isStaff();
      }
    }
    
    // ============================================
    // DEFAULT: Deny all other access
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

