rules_version = '2';

service cloud.firestore {

  match /databases/{database}/documents {

  


    function isAuthenticated() {

      return request.auth != null;

    }

        

    function getUserData() {

      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;

    }

    

    function userExistsAndActive() {

      return isAuthenticated() && 

             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&

             getUserData().isActive == true;

    }

    

    function isManager() {

      return userExistsAndActive() && getUserData().role == 'manager';

    }

    

    function isHR() {

      return userExistsAndActive() && getUserData().role == 'hr';

    }

    

    function isStaff() {

      return userExistsAndActive() && getUserData().role == 'staff';

    }

    

    function isAdmin() {

      return userExistsAndActive() && (

        getUserData().role in ['manager', 'hr', 'staff'] ||

        (getUserData().permissions is list && 

         getUserData().permissions.hasAny(['all', 'post_moderation', 'user_management', 'analytics', 'monitoring', 'system_config', 'message_oversight', 'role_management']))

      );

    }

    

    function hasPermission(permission) {

      return userExistsAndActive() && 

             getUserData().permissions is list &&

             (getUserData().permissions.hasAny([permission, 'all']));

    }

    

    function hasRoleManagementPermission() {

      return hasPermission('role_management');

    }



    function isSignedIn() {

      return request.auth != null;

    }



    function isSelf(userId) {

      return isSignedIn() && request.auth.uid == userId;

    }



    function conversationContainsUser(conversationId) {

      return isSignedIn() &&

        (get(/databases/$(database)/documents/conversations/$(conversationId)).data.participant1Id == request.auth.uid ||

         get(/databases/$(database)/documents/conversations/$(conversationId)).data.participant2Id == request.auth.uid);

    }



    match /users/{userId} {

      allow read: if isSignedIn(); 

      allow create, update: if isSelf(userId);

      allow delete: if false;

      allow list: if request.query.limit <= 1 && resource == null || request.auth == null;

    }

    

    match /sessions/{userId} {

      allow read, write: if request.auth != null && request.auth.uid == userId;

    }

    

    match /verificationRequests/{userId} {

      allow create: if request.auth != null && 

        request.auth.uid == userId &&

        request.resource.data.userId == userId &&

        request.resource.data.keys().hasAll(['userId', 'documents', 'submittedAt', 'status']) &&

        request.resource.data.status == 'pending';

      

      allow read: if request.auth != null && request.auth.uid == userId;

      

      allow update: if request.auth != null && 

        request.auth.uid == userId &&

        (resource.data.status == 'pending' || resource.data.status == 'rejected') &&

        request.resource.data.status == 'pending';

      

      allow read: if isAdmin();

      

      allow update: if isAdmin() &&

  			request.resource.data.status in ['approved', 'rejected', 'pending'];

    }

    

    match /attendance/{attendanceId} {

      allow read: if isSignedIn() && (

        resource.data.jobseekerId == request.auth.uid ||

        resource.data.recruiterId == request.auth.uid

      );



      allow list: if isSignedIn();



      allow create: if isSignedIn() &&

        request.resource.data.jobseekerId == request.auth.uid &&

        request.resource.data.applicationId is string &&

        request.resource.data.postId is string &&

        request.resource.data.recruiterId is string;



      allow update: if isSignedIn() &&

        resource.data.jobseekerId == request.auth.uid &&

        request.resource.data.jobseekerId == resource.data.jobseekerId &&

        request.resource.data.recruiterId == resource.data.recruiterId &&

        request.resource.data.postId == resource.data.postId &&

        request.resource.data.applicationId == resource.data.applicationId;



      allow delete: if false;

    }

    

    

      match /report_categories/{document} {

      allow read: if isSignedIn();

    }

    

    match /booking_requests/{requestId} {

      allow get: if isSignedIn() && (

        resource.data.jobseekerId == request.auth.uid ||

        resource.data.recruiterId == request.auth.uid

      );

      

      allow list: if isSignedIn();

      

      allow create: if isSignedIn() &&

        request.resource.data.jobseekerId == request.auth.uid &&

        request.resource.data.status == 'pending';

      

      allow update: if isSignedIn() &&

        resource.data.recruiterId == request.auth.uid &&

        request.resource.data.status in ['approved', 'rejected'] &&

        request.resource.data.jobseekerId == resource.data.jobseekerId &&

        request.resource.data.recruiterId == resource.data.recruiterId &&

        request.resource.data.slotId == resource.data.slotId &&

        request.resource.data.matchId == resource.data.matchId;

      

      allow delete: if false;

    }

    

    match /availability_slots/{slotId} {

      allow get: if isSignedIn() && (

        resource.data.recruiterId == request.auth.uid ||

        resource.data.isAvailable == true

      );

      

      allow list: if isSignedIn();

      

      allow create: if isSignedIn() &&

        request.resource.data.recruiterId == request.auth.uid &&

        request.resource.data.date is timestamp &&

        request.resource.data.startTime is string &&

        request.resource.data.endTime is string &&

        request.resource.data.isAvailable is bool;

      

      allow update: if isSignedIn() &&

        resource.data.recruiterId == request.auth.uid &&

        request.resource.data.recruiterId == resource.data.recruiterId &&

        (request.resource.data.date == resource.data.date) &&

        (request.resource.data.startTime == resource.data.startTime) &&

        (request.resource.data.endTime == resource.data.endTime);

      

      allow delete: if isSignedIn() &&

        resource.data.recruiterId == request.auth.uid;

    }




    match /notifications/{notificationId} {

      allow get: if isSignedIn() && resource.data.userId == request.auth.uid;

      allow list: if isSignedIn();

      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;

      allow create: if isSignedIn() && request.resource.data.userId is string;

      allow delete: if false;

    }



    match /wallets/{userId} {

      allow read, create: if isSelf(userId);

      

      allow read: if isSignedIn();

      allow update: if isSelf(userId) || (

        isSignedIn() && 

        request.resource.data.balance is number &&

        request.resource.data.heldCredits is number &&

        request.resource.data.heldCredits < resource.data.heldCredits &&

        request.resource.data.balance <= resource.data.balance

      );

      

      allow delete: if false;



      match /transactions/{transactionId} {

        allow read, create: if isSelf(userId);

        

        allow get: if isSignedIn() &&

          resource != null &&

          resource.data.userId == userId;

        

        allow list: if isSignedIn();

        

        allow create: if isSignedIn() && 

          request.resource.data.userId == userId &&

          request.resource.data.type in ['debit', 'credit'] &&

          request.resource.data.amount is int &&

          request.resource.data.amount > 0 &&

          request.resource.data.description is string &&

          request.resource.data.createdAt is timestamp &&

          (request.resource.data.referenceId == null || 

           request.resource.data.referenceId is string) &&

          (isAdmin() || 

           request.resource.data.description != 'Post creation fee (Released)');

        

        allow update: if isSignedIn() && (

          (resource.data.userId == userId &&

           resource.data.description == 'Application fee (On Hold)' &&

           resource.data.referenceId is string &&

           (request.resource.data.description == 'Application fee' ||

            request.resource.data.description == 'Application fee (Released)') &&

           request.resource.data.userId == resource.data.userId &&

           request.resource.data.amount == resource.data.amount &&

           request.resource.data.referenceId == resource.data.referenceId &&

           request.resource.data.createdAt == resource.data.createdAt &&

           (request.resource.data.description == 'Application fee (Released)'

              ? (resource.data.type == 'debit' && request.resource.data.type == 'credit')

              : request.resource.data.type == resource.data.type)) ||

          (isAdmin() &&

           resource.data.userId == userId &&

           resource.data.description == 'Post creation fee (On Hold)' &&

           resource.data.referenceId is string &&

           (request.resource.data.description == 'Post creation fee' ||

            request.resource.data.description == 'Post creation fee (Released)') &&

           request.resource.data.userId == resource.data.userId &&

           request.resource.data.amount == resource.data.amount &&

           request.resource.data.referenceId == resource.data.referenceId &&

           request.resource.data.createdAt == resource.data.createdAt &&

           (request.resource.data.description == 'Post creation fee (Released)'

              ? (resource.data.type == 'debit' && request.resource.data.type == 'credit')

              : request.resource.data.type == resource.data.type))

        );

        

        allow delete: if false;

      }

    }

      



    match /pending_payments/{paymentId} {

      allow create: if isSignedIn() && request.resource.data.uid == request.auth.uid;

      allow get, update: if isSelf(resource.data.uid);

      allow list: if isSignedIn();

      allow delete: if false;

    }



    match /posts/{postId} {

      allow read: if isSignedIn();

      allow create: if isSignedIn() && 

        request.resource.data.ownerId == request.auth.uid &&

        (request.resource.data.status == null ||

         request.resource.data.status in ['pending', 'active', 'completed', 'deleted']);

      



      allow update: if isSignedIn() && (

        (isAdmin() &&

         (request.resource.data.status == null ||

          request.resource.data.status in ['pending', 'active', 'completed', 'deleted', 'rejected'])) ||

        (resource.data.ownerId == request.auth.uid &&

         (request.resource.data.status == null ||

          request.resource.data.status in ['pending', 'active', 'completed', 'deleted'])) ||

        (resource.data.ownerId == request.resource.data.ownerId &&

         request.resource.data.applicants is int &&

         (request.resource.data.status == null || request.resource.data.status == resource.data.status))

      );

      

      allow delete: if isSignedIn() && resource.data.ownerId == request.auth.uid;

    }



    match /applications/{applicationId} {

      allow read: if isSignedIn() && (

        resource.data.jobseekerId == request.auth.uid ||

        resource.data.recruiterId == request.auth.uid

      );



      allow list: if isSignedIn();



      allow create: if isSignedIn() &&

        request.resource.data.jobseekerId == request.auth.uid &&

        request.resource.data.status == 'pending';



      allow update: if isSignedIn() && (

        (resource.data.recruiterId == request.auth.uid &&

         request.resource.data.status in ['approved', 'rejected', 'deleted'] &&

         request.resource.data.jobseekerId == resource.data.jobseekerId &&

         request.resource.data.recruiterId == resource.data.recruiterId &&

         request.resource.data.postId == resource.data.postId) ||

        (resource.data.jobseekerId == request.auth.uid &&

         request.resource.data.status == 'deleted' &&

         request.resource.data.jobseekerId == resource.data.jobseekerId &&

         request.resource.data.recruiterId == resource.data.recruiterId &&

         request.resource.data.postId == resource.data.postId) ||

        (resource.data.jobseekerId == request.auth.uid &&

         request.resource.data.jobseekerId == resource.data.jobseekerId &&

         request.resource.data.recruiterId == resource.data.recruiterId &&

         request.resource.data.postId == resource.data.postId &&

         request.resource.data.status == resource.data.status &&

         request.resource.data.creditsProcessed is bool)

      );



      allow delete: if isSignedIn() &&

        resource.data.recruiterId == request.auth.uid;

    }



    match /reviews/{reviewId} {

      allow read: if isSignedIn();



      allow create: if isSignedIn() && (

        (request.resource.data.recruiterId == request.auth.uid &&

          request.resource.data.postId is string &&

          request.resource.data.jobseekerId is string &&

          request.resource.data.rating is int &&

          request.resource.data.rating >= 1 &&

          request.resource.data.rating <= 5 &&

          request.resource.data.comment is string &&

          request.resource.data.createdAt is timestamp &&

          exists(/databases/$(database)/documents/posts/$(request.resource.data.postId)) &&

          get(/databases/$(database)/documents/posts/$(request.resource.data.postId)).data.status == 'completed' &&

          get(/databases/$(database)/documents/posts/$(request.resource.data.postId)).data.ownerId == request.auth.uid)

        ||



        (request.resource.data.jobseekerId == request.auth.uid &&

          request.resource.data.postId is string &&

          request.resource.data.recruiterId is string &&

          request.resource.data.rating is int &&

          request.resource.data.rating >= 1 &&

          request.resource.data.rating <= 5 &&

          request.resource.data.comment is string &&

          request.resource.data.createdAt is timestamp &&

          // Verify post exists and is completed

          exists(/databases/$(database)/documents/posts/$(request.resource.data.postId)) &&

          get(/databases/$(database)/documents/posts/$(request.resource.data.postId)).data.status == 'completed')

      );



      allow update: if false;

      allow delete: if false;

    }





    match /conversations/{conversationId} {

      allow get: if isSignedIn() && (

        resource == null ||

        resource.data.participant1Id == request.auth.uid ||

        resource.data.participant2Id == request.auth.uid

      );



      allow list: if isSignedIn();



      allow update: if isSignedIn() && (

        resource.data.participant1Id == request.auth.uid ||

        resource.data.participant2Id == request.auth.uid

      );



      allow create: if isSignedIn() && (

        request.resource.data.participant1Id == request.auth.uid ||

        request.resource.data.participant2Id == request.auth.uid

      );



      allow delete: if false;



      match /messages/{messageId} {

        allow get: if isSignedIn() && (

          (resource != null && (

            resource.data.senderId == request.auth.uid ||

            resource.data.receiverId == request.auth.uid

          )) ||

          (exists(/databases/$(database)/documents/conversations/$(conversationId)) &&

           (get(/databases/$(database)/documents/conversations/$(conversationId)).data.participant1Id == request.auth.uid ||

            get(/databases/$(database)/documents/conversations/$(conversationId)).data.participant2Id == request.auth.uid))

        );





        allow list: if isSignedIn() && (

          exists(/databases/$(database)/documents/conversations/$(conversationId)) &&

          (get(/databases/$(database)/documents/conversations/$(conversationId)).data.participant1Id == request.auth.uid ||

           get(/databases/$(database)/documents/conversations/$(conversationId)).data.participant2Id == request.auth.uid)

        );



        allow create: if isSignedIn() &&

          request.resource.data.senderId == request.auth.uid &&

          request.resource.data.receiverId is string &&

          (

            (exists(/databases/$(database)/documents/conversations/$(conversationId)) &&

             (get(/databases/$(database)/documents/conversations/$(conversationId)).data.participant1Id == request.auth.uid ||

              get(/databases/$(database)/documents/conversations/$(conversationId)).data.participant2Id == request.auth.uid)) ||

            !exists(/databases/$(database)/documents/conversations/$(conversationId))

          );



        allow update: if isSignedIn() && (

          resource.data.receiverId == request.auth.uid ||

          resource.data.senderId == request.auth.uid

        );



        allow delete: if false;

      }

    }

   

    

    match /reports/{reportId} {

      allow get: if isSignedIn() && (

        resource.data.reporterId == request.auth.uid ||

        isManager() || isHR() || isStaff()

      );

      

      allow list: if isSignedIn();

      

      allow create: if isSignedIn() &&

        request.resource.data.reporterId == request.auth.uid &&

        request.resource.data.type in ['post', 'jobseeker'] &&

        request.resource.data.reason is string &&

        request.resource.data.description is string &&

        request.resource.data.status == 'pending';

      

      allow update: if isManager() || isHR() || isStaff();

      

      allow delete: if isManager() || isHR() || isStaff();

    }





    match /{document=**} {

      allow read, write: if false;

    }

    

    match /roles/{roleId} {

      allow read, list: if isAuthenticated();

      allow create, update, delete: if false;

    }



    match /users/{document=**} {

      allow list: if hasPermission('user_management') || 

                   isManager() || 

                   isHR() || 

                   isStaff();

      

      allow get: if hasPermission('user_management') || 

                  isManager() || 

                  isHR() || 

                  isStaff();

    }

    

    match /users/{userId} {

      allow get: if isAuthenticated() && request.auth.uid == userId;

      

      allow get: if hasPermission('user_management') || 

                  isManager() || 

                  isHR() || 

                  isStaff();

      

      allow create, update: if isSelf(userId) || 

                            hasPermission('user_management') || 

                            isManager() || 

                            isHR() || 

                            isStaff();

      

      allow delete: if false;

    }

    

    match /reports/{document=**} {

      allow list: if hasPermission('user_management') || 

                   hasPermission('post_moderation') || 

                   isManager() || 

                   isHR() || 

                   isStaff();



      allow get: if hasPermission('user_management') || 

                  hasPermission('post_moderation') || 

                  isManager() || 

                  isHR() || 

                  isStaff();

    }

    

    match /reports/{reportId} {

      allow get: if isSignedIn() && resource.data.reporterId == request.auth.uid;

      

      allow get: if hasPermission('user_management') || 

                  hasPermission('post_moderation') || 

                  isManager() || 

                  isHR() || 

                  isStaff();

      

      allow list: if hasPermission('user_management') || 

                   hasPermission('post_moderation') || 

                   isManager() || 

                   isHR() || 

                   isStaff();

      

      allow create: if isSignedIn() &&

        request.resource.data.reporterId == request.auth.uid &&

        request.resource.data.type in ['post', 'jobseeker'] &&

        request.resource.data.reason is string &&

        request.resource.data.description is string &&

        request.resource.data.status == 'pending';

      

      allow update, delete: if hasPermission('user_management') || 

                             hasPermission('post_moderation') || 

                             isManager() || 

                             isHR() || 

                             isStaff();

    }



    match /posts/{postId} {

      allow read, list, write: if hasPermission('post_moderation') || 

                                 isManager() || 

                                 isHR() || 

                                 isStaff();

    }



    match /job_posts/{postId} {

      allow read, list, write: if hasPermission('post_moderation') || 

                                 hasPermission('analytics') || 

                                 isManager() || 

                                 isHR() || 

                                 isStaff();

    }

    



    match /categories/{categoryId} {

      allow read, list: if isSignedIn();

      

      allow create: if hasPermission('post_moderation') || 

                     isManager() || 

                     isHR() || 

                     isStaff();

      

      allow update: if isSignedIn() && (

        hasPermission('post_moderation') || 

        isManager() || 

        isHR() || 

        isStaff() ||

        (request.resource.data.name == resource.data.name &&

         request.resource.data.description == resource.data.description &&

         request.resource.data.isActive == resource.data.isActive &&

         request.resource.data.jobCount is int &&

         request.resource.data.updatedAt is timestamp)

      );

      

      allow delete: if hasPermission('post_moderation') || 

                     isManager() || 

                     isHR() || 

                     isStaff();

    }

    



    match /analytics/{docId} {

      allow read, list, write: if hasPermission('analytics') || 

                                 isManager() || 

                                 isHR();

    }

    



    match /wallets/{walletId} {

      allow read, list, write: if hasPermission('user_management') || 

                                 isManager() || 

                                 isHR();

    }

    



    

    // Allow list queries on logs collection

    match /logs/{document=**} {

      allow list: if hasPermission('user_management') || 

                   isManager() || 

                   isHR();

      

      allow get: if hasPermission('user_management') || 

                  isManager() || 

                  isHR();

    }

    

    match /logs/{logId} {

      allow read, write: if hasPermission('user_management') || 

                          isManager() || 

                          isHR();

    }

    



    match /applications/{applicationId} {

      allow read, list, write: if hasPermission('post_moderation') || 

                                 isManager() || 

                                 isHR() || 

                                 isStaff();

    }

    



    match /pending_payments/{paymentId} {

      allow read, list, write: if hasPermission('analytics') || 

                                 isManager() || 

                                 isHR();

    }

    



    match /notifications/{notificationId} {

      allow write: if hasPermission('user_management') || 

                    isManager() || 

                    isHR() || 

                    isStaff();

      

      allow read, list: if isAuthenticated();

    }

    



    match /tagCategories/{tagCategoryId} {

      allow read, list: if isSignedIn();

      allow write: if hasPermission('post_moderation') || 

                    isManager() || 

                    isHR() || 

                    isStaff();

    }

    



    match /tags/{tagId} {

      allow read, list: if isSignedIn();

      allow write: if hasPermission('post_moderation') || 

                    isManager() || 

                    isHR() || 

                    isStaff();

    }

    



    match /matching_rules/{ruleId} {

      allow read, list: if isAuthenticated();

      allow write: if hasPermission('system_config') || 

                    isManager() || 

                    isHR() || 

                    isStaff();

    }

    



    match /system_config/{configId} {

      allow read, list: if isAuthenticated();

      allow write: if hasPermission('system_config') || 

                    isManager() || 

                    isHR() || 

                    isStaff();

    }

    



    match /job_matches/{matchId} {

      allow get: if isAuthenticated() && (

        resource.data.jobseekerId == request.auth.uid ||

        resource.data.recruiterId == request.auth.uid

      );

      

      allow list: if isAuthenticated();

      

      allow create: if isAuthenticated() &&

        request.resource.data.jobId is string &&

        request.resource.data.jobTitle is string &&

        request.resource.data.companyName is string &&

        request.resource.data.recruiterId is string &&

        request.resource.data.jobseekerId is string &&

        request.resource.data.status is string &&

        request.resource.data.status in ['pending', 'applied'] &&

        (request.resource.data.matchingStrategy == null ||

         request.resource.data.matchingStrategy is string &&

         request.resource.data.matchingStrategy in ['embedding_ann', 'stable_optimal']);

      

      allow update: if isAuthenticated() && (

        (resource.data.jobseekerId == request.auth.uid &&

         request.resource.data.status == 'applied' &&

         resource.data.status == 'pending' &&

         request.resource.data.jobId == resource.data.jobId &&

         request.resource.data.jobseekerId == resource.data.jobseekerId &&

         request.resource.data.recruiterId == resource.data.recruiterId) ||

        (request.resource.data.jobId is string &&

         request.resource.data.jobTitle is string &&

         request.resource.data.companyName is string &&

         request.resource.data.recruiterId is string &&

         request.resource.data.jobseekerId is string &&

         request.resource.data.status is string &&

         request.resource.data.status in ['pending', 'applied'] &&

         (request.resource.data.matchingStrategy == null ||

          request.resource.data.matchingStrategy is string &&

          request.resource.data.matchingStrategy in ['embedding_ann', 'stable_optimal']) &&

         request.resource.data.jobId == resource.data.jobId &&

         request.resource.data.jobseekerId == resource.data.jobseekerId &&

         request.resource.data.recruiterId == resource.data.recruiterId)

      );

      

      allow delete: if false;

    }

    



    match /messages/{msgId} {

      allow read, list, write: if hasPermission('message_oversight') || 

                                 isManager() || 

                                 isHR() || 

                                 isStaff();

    }

    



    match /conversations/{conversationId} {

      allow read, list: if hasPermission('message_oversight') || 

                         hasPermission('analytics') || 

                         isManager() || 

                         isHR() || 

                         isStaff();

      

      allow write: if hasPermission('message_oversight') || 

                    isManager() || 

                    isHR() || 

                    isStaff();

      

      match /messages/{messageId} {

        allow read, list: if hasPermission('message_oversight') || 

                           hasPermission('analytics') || 

                           isManager() || 

                           isHR() || 

                           isStaff();

        

        allow write: if hasPermission('message_oversight') || 

                      isManager() || 

                      isHR() || 

                      isStaff();

      }

    }

    



    match /report_categories/{categoryId} {

      allow read: if isAdmin();



      allow create: if isAdmin() && 

                       request.resource.data.keys().hasAll(['name', 'description', 'isEnabled', 'creditDeduction', 'updatedAt']) &&

                       request.resource.data.name is string &&

                       request.resource.data.description is string &&

                       request.resource.data.isEnabled is bool &&

                       request.resource.data.creditDeduction is int &&

                       request.resource.data.creditDeduction >= 0;

      

      allow update: if isAdmin() && 

                       request.resource.data.keys().hasAll(['name', 'description', 'isEnabled', 'creditDeduction', 'updatedAt']) &&

                       request.resource.data.name is string &&

                       request.resource.data.description is string &&

                       request.resource.data.isEnabled is bool &&

                       request.resource.data.creditDeduction is int &&

                       request.resource.data.creditDeduction >= 0;

      

      allow delete: if false;

    }

    

    

    match /admin_otps/{otpId} {

  allow create: if isAuthenticated() && 

                   request.resource.data.userId == request.auth.uid;

  

  allow read: if isAuthenticated() && 

                 resource.data.userId == request.auth.uid;

  

  allow update: if isAuthenticated() && 

                   resource.data.userId == request.auth.uid &&

                   // Only allow updating attempts or isUsed fields

                   (

                     request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attempts']) ||

                     (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isUsed', 'usedAt']) &&

                      request.resource.data.isUsed == true)

                   );

  

  allow delete: if false;

}

    

   

    match /{document=**} {

      allow read, write: if false;

    }

    

  }

}


